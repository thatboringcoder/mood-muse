import React, { useMemo, useRef, useState } from "react";
import { motion, AnimatePresence } from "framer-motion";
import { Heart, HeartCrack, Laugh, Coffee, Share2, RefreshCcw, CupSoda } from "lucide-react";
import html2canvas from "html2canvas";

// Tailwind is available by default in Canvas preview.
// All code is self-contained in this single component.

const MOODS = {
  LOVEY: "Lovey-Dovey",
  HEARTBROKEN: "Heartbroken & Hangry",
  FLIRTY: "Flirty & Funky",
  CHILL: "Just Chilling",
};

const SHAYARIS = {
  [MOODS.LOVEY]: [
    "‡§§‡•Å‡§Æ‡•ç‡§π‡§æ‡§∞‡•Ä ‚òï ‡§Æ‡•Å‡§∏‡•ç‡§ï‡§æ‡§® ‡§Æ‡•á‡§Ç ‡§ö‡•Ä‡§®‡•Ä ‡§∏‡•Ä ‡§Æ‡§ø‡§†‡§æ‡§∏ ‡§π‡•à, ‡§π‡§∞ ‡§ò‡•Ç‡§Ç‡§ü ‡§Æ‡•á‡§Ç ‡§¨‡§∏ ‡§§‡•Å‡§Æ‡•ç‡§π‡§æ‡§∞‡§æ ‡§π‡•Ä ‡§è‡§π‡§∏‡§æ‡§∏ ‡§π‡•à‡•§",
    "‡§§‡•á‡§∞‡•Ä ‡§¨‡§æ‡§§‡•á‡§Ç ‡§ó‡§∞‡§Æ ‡§ö‡§æ‡§Ø, ‡§Æ‡•á‡§∞‡•Ä ‡§∂‡§æ‡§Æ‡•á‡§Ç ‡§§‡•á‡§∞‡§æ ‡§®‡§æ‡§Æ; ‡§∏‡§æ‡§• ‡§¨‡•à‡§†‡•á ‡§ú‡•ã ‡§è‡§ï ‡§¶‡§´‡§º‡§æ, ‡§•‡§Æ ‡§ú‡§æ‡§è ‡§π‡§∞ ‡§è‡§ï ‡§ï‡§æ‡§Æ‡•§",
    "You stir my tea and time stands still; love pours gently, cup overfill.",
    "‡§§‡•á‡§∞‡•Ä ‡§Ü‡§Å‡§ñ‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§ú‡•ã ‡§¶‡•á‡§ñ‡§æ, ‡§∞‡•Ç‡§†‡§æ ‡§Æ‡•â‡§®‡§∏‡•Ç‡§® ‡§≠‡•Ä ‡§≠‡•Ä‡§ó ‡§ó‡§Ø‡§æ; ‡§á‡§∂‡•ç‡§ï‡§º ‡§ï‡•Ä ‡§ñ‡§º‡•Å‡§∂‡§¨‡•Ç ‡§∏‡•á ‡§Æ‡•á‡§∞‡§æ ‡§π‡§∞ ‡§ï‡§™ ‡§Æ‡§π‡§ï ‡§ó‡§Ø‡§æ‡•§",
    "Dil ki tapri par baithi ho tum, har lafz me tumhari hi khushboo hai.",
    "‡§ö‡§æ‡§Ø ‡§ï‡•Ä ‡§≠‡§æ‡§™ ‡§Æ‡•á‡§Ç ‡§§‡•á‡§∞‡§æ ‡§ö‡•á‡§π‡§∞‡§æ, ‡§ú‡•à‡§∏‡•á ‡§∏‡•Å‡§¨‡§π ‡§ï‡•Ä ‡§ß‡•Ç‡§™; ‡§§‡•á‡§∞‡•á ‡§¨‡§ø‡§®‡§æ ‡§Ö‡§ß‡•Ç‡§∞‡•Ä, ‡§Æ‡•á‡§∞‡•Ä ‡§π‡§∞ ‡§è‡§ï ‡§ò‡•Ç‡§Ç‡§ü‡•§",
    "Two sugars, one heart‚Äîours.",
    "‡§§‡•á‡§∞‡§æ ‡§π‡§æ‡§• ‡§î‡§∞ ‡§Æ‡•á‡§∞‡§æ ‡§ï‡§™, ‡§Ü‡§ú ‡§Æ‡•å‡§∏‡§Æ ‡§ï‡•Å‡§õ ‡§ú‡§º‡•ç‡§Ø‡§æ‡§¶‡§æ ‡§π‡•Ä ‡§ñ‡§º‡•Å‡§∂‡§ó‡§µ‡§æ‡§∞ ‡§π‡•à‡•§",
    "You + me + garam chai = perfect vibe.",
    "‡§ß‡§°‡§º‡§ï‡§®‡•ã‡§Ç ‡§ï‡•Ä ‡§ï‡•á‡§§‡§≤‡•Ä ‡§∏‡•Ä‡§ü‡•Ä ‡§¶‡•á, ‡§ú‡§¨ ‡§§‡•Å‡§Æ ‡§∏‡§æ‡§Æ‡§®‡•á ‡§¨‡•à‡§†‡•ã‡•§",
  ],
  [MOODS.HEARTBROKEN]: [
    "‡§ï‡§°‡§º‡§µ‡•Ä ‡§∏‡•Ä ‡§ö‡•Å‡§∏‡•ç‡§ï‡•Ä, ‡§®‡§Æ‡§ï-‡§∏‡•Ä ‡§∞‡§æ‡§§‡•á‡§Ç; ‡§ü‡•Ç‡§ü‡•á ‡§ï‡§™ ‡§ú‡•à‡§∏‡§æ ‡§¶‡§ø‡§≤, ‡§ú‡•ã ‡§´‡§ø‡§∞ ‡§≠‡•Ä ‡§¨‡§æ‡§Ç‡§ü‡•á‡•§",
    "Barish bhi royi aaj, jab tum yaad aaye; thandi chai sa ho gaya dil, jab tum na samajh ‡§™‡§æ‡§è‡•§",
    "Hangry hoon, par dil aur bhooka‚Äîtera ek jawab, aur ‡§∏‡•å ‡§∏‡§µ‡§æ‡§≤ ‡§∏‡•Å‡§≤‡§ó‡§æ‡•§",
    "‡§Æ‡•Å‡§ù‡§∏‡•á ‡§Æ‡•á‡§∞‡•Ä ‡§Æ‡§ø‡§†‡§æ‡§∏ ‡§õ‡•Ä‡§® ‡§≤‡•á ‡§ó‡§è ‡§§‡•Å‡§Æ, ‡§Ö‡§¨ ‡§π‡§∞ ‡§ö‡§æ‡§Ø ‡§¨‡•á‡§∏‡•ç‡§µ‡§æ‡§¶ ‡§≤‡§ó‡§§‡•Ä ‡§π‡•à‡•§",
    "You left mid-sip; the storm finished my cup.",
    "‡§ü‡•Ç‡§ü‡•Ä ‡§π‡•Å‡§à ‡§™‡•ç‡§≤‡•á‡§ü ‡§Æ‡•á‡§Ç ‡§™‡§∞‡§õ‡§æ‡§á‡§Ø‡§æ‡§Å ‡§≠‡•Ä ‡§ï‡§ü‡§§‡•Ä ‡§π‡•à‡§Ç; ‡§§‡•á‡§∞‡•á ‡§¨‡§æ‡§¶ ‡§ú‡§º‡§ø‡§Ç‡§¶‡§ó‡•Ä ‡§ï‡•Ä ‡§∞‡•ã‡§ü‡§ø‡§Ø‡§æ‡§Å ‡§≠‡•Ä ‡§ú‡§≤‡§§‡•Ä ‡§π‡•à‡§Ç‡•§",
    "‡§•‡•ã‡§°‡§º‡•Ä ‡§∏‡•Ä ‡§¨‡§æ‡§∞‡§ø‡§∂, ‡§•‡•ã‡§°‡§º‡§æ ‡§∏‡§æ ‡§∂‡•ã‡§∞‚Äî‡§¶‡§ø‡§≤ ‡§ï‡§æ ‡§¶‡§∞‡§µ‡§æ‡§ú‡§º‡§æ ‡§¨‡§Ç‡§¶, ‡§™‡§∞ ‡§¨‡§æ‡§π‡§∞ ‡§π‡•à ‡§ï‡•ã‡§π‡§∞‡§æ‡§Æ-‡§∏‡§æ ‡§î‡§∞‡•§",
    "‡§Æ‡•á‡§∞‡•á ‡§∂‡§π‡§∞ ‡§Æ‡•á‡§Ç ‡§Ö‡§¨ ‡§ß‡•Ç‡§™ ‡§®‡§π‡•Ä‡§Ç, ‡§¨‡§∏ ‡§ß‡•Å‡§Ü‡§Å ‡§π‡•à; ‡§ö‡§æ‡§Ø ‡§†‡§Ç‡§°‡•Ä ‡§π‡•à, ‡§î‡§∞ ‡§Æ‡•à‡§Ç ‡§≠‡•Ä‡•§",
    "Cracked-heart cup, leaking love‚Äîrefill unavailable.",
    "‡§§‡•Å‡§Æ‡•ç‡§π‡§æ‡§∞‡•Ä ‡§ö‡•Å‡§™‡•ç‡§™‡•Ä ‡§π‡•Ä ‡§∏‡§¨‡§∏‡•á ‡§≠‡§æ‡§∞‡•Ä ‡§≤‡§ó‡•Ä, ‡§ö‡§æ‡§Ø ‡§ï‡•Ä ‡§ï‡•á‡§§‡§≤‡•Ä ‡§∏‡•á ‡§≠‡•Ä ‡§ú‡§º‡•ç‡§Ø‡§æ‡§¶‡§æ ‡§∏‡•Ä‡§ü‡•Ä ‡§Æ‡•á‡§∞‡•Ä ‡§Ü‡§Å‡§ñ‡•ã‡§Ç ‡§®‡•á ‡§¶‡•Ä‡•§",
  ],
  [MOODS.FLIRTY]: [
    "Sticker jaisi muskuraahat, filter jaisi chaal‚Äîtum dikhti ho to chai bhi ho jaati hai virallll!",
    "Hi tea? No, high on you. üòâ",
    "‡§¶‡§ø‡§≤ ‡§™‡•á ‡§® ‡§≤‡§ó‡§æ blush, sips pe laga hush‚Äîtum bolo to chai bhi bole ‚Äòhush-hush‚Äô.",
    "‡§§‡•Å‡§Æ ‡§™‡§æ‡§∏ ‡§Ü‡§ì ‡§§‡•ã kettle bhi whistle kare do baar‡•§",
    "Garam garam vibes, thandi thandi hawa‚Äîtum ho to har cup me taaza nasha‡•§",
    "Nazrein mili, cup hil gaya; sharmana mat, sip pe sip chal gaya‡•§",
    "Teri aankhon ka emoji üòâ, meri lines ka energy!",
    "You‚Äôre the masala in my chai‚Äîspice it up?",
    "‡§π‡§≤‡•ç‡§ï‡•Ä ‡§∏‡•Ä ‡§¨‡§æ‡§§, ‡§≠‡§æ‡§∞‡•Ä ‡§∏‡•Ä ‡§ß‡§°‡§º‡§ï‡§®‚Äîtumhare ‚Äòhi‚Äô me hi poora weekend.",
    "Flirty filter on; pyaar ka bokeh strong!",
  ],
  [MOODS.CHILL]: [
    "‡§∂‡•ã‡§∞ ‡§∏‡•á ‡§¶‡•Ç‡§∞, ‡§ï‡§ø‡§§‡§æ‡§¨ ‡§ï‡•á ‡§∏‡§æ‡§•; ‡§ö‡§æ‡§Ø ‡§ï‡•Ä ‡§ñ‡•Å‡§∂‡§¨‡•Ç, ‡§î‡§∞ ‡§ñ‡•Å‡§¶ ‡§ï‡•á ‡§∏‡§æ‡§•‡•§",
    "Slow sips, soft sunsets, silent wins.",
    "‡§ï‡§Ç‡§¨‡§≤, playlist, ‡§î‡§∞ ‡§ó‡§∞‡§Æ ‡§ï‡§™; ‡§¨‡§∏ ‡§á‡§§‡§®‡§æ ‡§π‡•Ä ‡§§‡•ã ‡§π‡•à ‡§∏‡•Å‡§ï‡•Ç‡§® ‡§ï‡§æ setup.",
    "No rush, just hush‚Äîchai and a little hush.",
    "‡§π‡§≤‡•ç‡§ï‡•Ä ‡§ß‡•Ç‡§™, ‡§≠‡§æ‡§∞‡•Ä ‡§Ü‡§≤‡§∏; ‡§Ü‡§ú ‡§ï‡§æ‡§Æ ‡§®‡§π‡•Ä‡§Ç, ‡§∏‡§ø‡§∞‡•ç‡§´‡§º ‡§∏‡§æ‡§Å‡§∏‡•§",
    "Breeze me chale, steam me ghule‚Äîdin ka pressure sab dhule.",
    "Minimal plans, maximal peace.",
    "‡§ñ‡§ø‡§°‡§º‡§ï‡•Ä ‡§ï‡•á ‡§™‡§æ‡§∏, ‡§¨‡§æ‡§¶‡§≤ ‡§ï‡•á ‡§™‡§æ‡§∏; ‡§Æ‡•à‡§Ç, ‡§Æ‡•á‡§∞‡•Ä ‡§ö‡§æ‡§Ø, ‡§î‡§∞ ‡§•‡•ã‡§°‡§º‡§æ-‡§∏‡§æ ‡§Ü‡§∏-‡§™‡§æ‡§∏‡•§",
    "Aaj ka mantra: sip, smile, repeat.",
    "‡§¶‡§ø‡§Æ‡§æ‡§ó on mute, ‡§¶‡§ø‡§≤ on snooze; ‡§¨‡§∏ ‡§ö‡§æ‡§Ø choose.",
  ],
};

const BGs = {
  [MOODS.LOVEY]:
    "bg-gradient-to-br from-rose-200 via-pink-100 to-amber-100",
  [MOODS.HEARTBROKEN]:
    "relative bg-gradient-to-br from-slate-900 via-gray-800 to-slate-700",
  [MOODS.FLIRTY]:
    "bg-gradient-to-tr from-fuchsia-300 via-yellow-200 to-sky-200",
  [MOODS.CHILL]:
    "bg-gradient-to-b from-emerald-50 via-teal-50 to-blue-50",
};

// Subtle background animations via utility classes + keyframes
const GlobalStyles = () => (
  <style>{`
    /* Twinkling stars for Lovey-Dovey */
    .twinkle:before, .twinkle:after { content: ""; position: absolute; inset: 0; background-image: radial-gradient(#ffffff80 1px, transparent 1px); background-size: 40px 40px; animation: twinkle 8s linear infinite; }
    .twinkle:after { background-size: 60px 60px; animation-duration: 11s; opacity: .6; }
    @keyframes twinkle { 0%{transform:translateY(0)} 100%{transform:translateY(-40px)} }

    /* Rain for Heartbroken */
    .rain:before { content:""; position:absolute; inset:0; background-image: repeating-linear-gradient( to bottom, #ffffff20 0 2px, transparent 2px 12px ); animation: rain 0.7s linear infinite; pointer-events:none; }
    @keyframes rain { from{background-position:0 0} to{background-position:0 12px} }

    /* Pop shapes for Flirty */
    .pop:before { content:""; position:absolute; inset:0; background:
      radial-gradient(circle at 20% 30%, #ff69b470 6px, transparent 8px),
      radial-gradient(circle at 70% 60%, #00ffd570 8px, transparent 10px),
      radial-gradient(circle at 40% 80%, #ffd70070 10px, transparent 12px);
      animation: floaty 10s ease-in-out infinite alternate; }
    @keyframes floaty { 0%{transform:translateY(0)} 100%{transform:translateY(-20px)} }

    /* Calm shimmer for Chill */
    .calm:before { content:""; position:absolute; inset:0; background: linear-gradient(120deg, #ffffff20 20%, transparent 40%, transparent 60%, #ffffff20 80%); background-size: 200% 200%; animation: calm 8s ease-in-out infinite; }
    @keyframes calm { 0%{background-position:0 50%} 100%{background-position:100% 50%} }
  `}</style>
);

function useRandomShayari(mood) {
  return useMemo(() => {
    const list = SHAYARIS[mood] || [];
    if (!list.length) return "";
    const idx = Math.floor(Math.random() * list.length);
    return list[idx];
  }, [mood]);
}

export default function ChaiShayariTapri() {
  const [phase, setPhase] = useState("home"); // home | brew | result
  const [mood, setMood] = useState(null);
  const shayari = useRandomShayari(mood);
  const shareRef = useRef(null);
  const [downloading, setDownloading] = useState(false);

  const startBrew = (m) => {
    setMood(m);
    setPhase("brew");
    // Simulate brewing time
    setTimeout(() => setPhase("result"), 1700);
  };

  const handleAnother = () => {
    setPhase("home");
    setMood(null);
  };

  const handleShare = async () => {
    if (!shareRef.current) return;
    try {
      setDownloading(true);
      const canvas = await html2canvas(shareRef.current, {
        backgroundColor: null,
        scale: 2,
      });
      const dataURL = canvas.toDataURL("image/png");
      const a = document.createElement("a");
      a.href = dataURL;
      const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g, "-");
      a.download = `chai-shayari-${stamp}.png`;
      a.click();
    } catch (e) {
      console.error(e);
      alert("Couldn't create image. Try again.");
    } finally {
      setDownloading(false);
    }
  };

  const moodButton = (label, Icon, scheme) => (
    <button
      onClick={() => startBrew(label)}
      className={`group flex items-center gap-3 rounded-2xl px-5 py-4 shadow-md transition transform active:scale-95 ${scheme}`}
    >
      <Icon className="w-6 h-6" />
      <span className="font-semibold">{label}</span>
    </button>
  );

  return (
    <div className="min-h-screen w-full overflow-hidden">
      <GlobalStyles />

      {/* Top Bar */}
      <header className="fixed top-0 left-0 right-0 z-30 backdrop-blur bg-white/50 border-b border-white/30">
        <div className="max-w-5xl mx-auto flex items-center justify-between px-4 py-3">
          <div className="flex items-center gap-2">
            <CupSoda className="w-6 h-6" />
            <span className="text-xl font-bold tracking-tight">Chai‚ÄëShayari Tapri</span>
          </div>
          <div className="text-xs md:text-sm opacity-70">‚ÄúWhat‚Äôs your mood? Let‚Äôs brew some shayari.‚Äù</div>
        </div>
      </header>

      {/* Content */}
      <main className="pt-20">
        <AnimatePresence mode="wait">
          {phase === "home" && (
            <motion.section
              key="home"
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              exit={{ opacity: 0, y: -20 }}
              className="max-w-5xl mx-auto px-4 py-12 flex flex-col items-center text-center"
            >
              <motion.div
                initial={{ scale: 0.9, opacity: 0 }}
                animate={{ scale: 1, opacity: 1 }}
                transition={{ type: "spring", stiffness: 120 }}
                className="relative"
              >
                <div className="absolute -inset-6 bg-gradient-to-tr from-amber-200 via-pink-200 to-rose-200 blur-3xl opacity-60 rounded-full"/>
                <div className="relative bg-white/70 border border-white/50 rounded-3xl p-8 shadow-xl">
                  <Coffee className="w-14 h-14 mx-auto" />
                  <h1 className="mt-4 text-3xl md:text-4xl font-extrabold tracking-tight">
                    What‚Äôs your mood? Let‚Äôs brew some shayari.
                  </h1>
                  <p className="mt-3 text-sm md:text-base opacity-80">
                    Tap a vibe below‚Äîyour cup will be ready in a sip.
                  </p>
                </div>
              </motion.div>

              <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mt-10 w-full">
                {moodButton(MOODS.LOVEY, Heart, "bg-rose-100 hover:bg-rose-200")}
                {moodButton(MOODS.HEARTBROKEN, HeartCrack, "bg-slate-200 hover:bg-slate-300")}
                {moodButton(MOODS.FLIRTY, Laugh, "bg-fuchsia-100 hover:bg-fuchsia-200")}
                {moodButton(MOODS.CHILL, Coffee, "bg-emerald-100 hover:bg-emerald-200")}
              </div>

              <p className="mt-10 text-xs opacity-70">Tip: Hit Share on results to download a stylized image for socials.</p>
            </motion.section>
          )}

          {phase === "brew" && (
            <motion.section
              key="brew"
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              exit={{ opacity: 0 }}
              className="h-[70vh] flex items-center justify-center"
            >
              <motion.div
                initial={{ scale: 0.9, opacity: 0 }}
                animate={{ scale: 1, opacity: 1 }}
                className="flex flex-col items-center"
              >
                <motion.div
                  className="w-28 h-28 rounded-full border-4 border-amber-400 flex items-center justify-center"
                  animate={{ rotate: [0, 0, -5, 5, -5, 5, 0], boxShadow: ["0 0 0 0 rgba(0,0,0,0)", "0 20px 60px -10px rgba(0,0,0,0.3)"] }}
                  transition={{ duration: 1.4, repeat: Infinity, ease: "easeInOut" }}
                >
                  <Coffee className="w-10 h-10" />
                </motion.div>
                <motion.div
                  className="mt-6 text-lg font-medium"
                  animate={{ opacity: [0.6, 1, 0.6] }}
                  transition={{ duration: 1.2, repeat: Infinity }}
                >
                  Brewing your cup of {mood}...
                </motion.div>
              </motion.div>
            </motion.section>
          )}

          {phase === "result" && (
            <motion.section
              key="result"
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              exit={{ opacity: 0 }}
              className={`relative min-h-[80vh] flex items-center justify-center px-4 ${BGs[mood]} ${
                mood === MOODS.LOVEY ? "twinkle" : mood === MOODS.HEARTBROKEN ? "rain" : mood === MOODS.FLIRTY ? "pop" : "calm"
              }`}
            >
              <div className="absolute inset-0" />

              <div className="relative max-w-3xl w-full">
                {/* Share Card */}
                <div ref={shareRef} className="relative rounded-3xl p-8 md:p-12 bg-white/70 border border-white/60 shadow-2xl backdrop-blur">
                  <div className="flex items-center gap-3 opacity-70 text-sm">
                    <Coffee className="w-5 h-5" />
                    <span>Chai‚ÄëShayari Tapri</span>
                  </div>
                  <blockquote className="mt-4 text-2xl md:text-3xl leading-relaxed font-semibold">
                    {shayari}
                  </blockquote>
                  <div className="mt-6 text-xs opacity-60">Mood: {mood}</div>
                </div>

                {/* Actions */}
                <div className="mt-6 flex flex-wrap gap-3">
                  <button onClick={handleAnother} className="inline-flex items-center gap-2 px-5 py-3 rounded-2xl bg-black text-white hover:opacity-90 active:scale-95">
                    <RefreshCcw className="w-4 h-4" />
                    Another Cup
                  </button>
                  <button onClick={handleShare} disabled={downloading} className="inline-flex items-center gap-2 px-5 py-3 rounded-2xl bg-white border hover:bg-white/80 active:scale-95">
                    <Share2 className="w-4 h-4" />
                    {downloading ? "Preparing‚Ä¶" : "Share this Chai"}
                  </button>
                </div>
              </div>
            </motion.section>
          )}
        </AnimatePresence>
      </main>

      {/* Footer */}
      <footer className="py-10 text-center text-xs opacity-70">
        Brewed with ‚ô• at the digital tapri.
      </footer>
    </div>
  );
}
